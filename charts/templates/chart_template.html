{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chart</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/lightweight-charts@3.4.0/dist/lightweight-charts.standalone.production.js"></script>
    <style>
      #chart {
        position: relative;
        width: 100%;
        height: 500px;
      }
      .btn-group {
        margin-bottom: 15px;
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark">
      <div class="container-fluid">
        <a class="navbar-brand" href="/">
          <img
            src="{% static 'assets/images/QUANTX-LOGO.png' %}"
            alt="Company Logo"
          />
        </a>
      </div>
    </nav>
    <div class="container-fluid">
      <div class="row justify-content-center">
        <div class="col-xl-10 col-lg-11 col-md-12">
          <div class="card">
            <div class="card-body">
              <div
                class="btn-group"
                role="group"
                aria-label="Chart Toggle Buttons"
              >
                <button
                  id="candlestick-btn"
                  type="button"
                  class="btn btn-primary"
                >
                  Candlestick
                </button>
                <button id="line-btn" type="button" class="btn btn-secondary">
                  Line
                </button>
                <button id="both-btn" type="button" class="btn btn-secondary">
                  Both
                </button>
              </div>
              <div id="chart"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Sample data from Django view
      const chartData = {{ chart_data|safe }};
      console.log(chartData[0].time, new Date(`${chartData[0].time}`).getTime() / 1000);

      // Convert time-only format to timestamps
      const data = chartData.map(item => ({
          time: new Date(`${item.time}`).getTime() / 1000,
          open: item.open,
          high: item.high,
          low: item.low,
          close: item.close
      }));

      // Create chart with responsive container
      const chartContainer = document.getElementById('chart');
      const chart = LightweightCharts.createChart(chartContainer, {
          width: chartContainer.clientWidth,
          height: 500,
      });

      // Adjust the chart width dynamically
      window.addEventListener('resize', () => {
          chart.resize(chartContainer.clientWidth, 500);
      });

      // Add candlestick series with specified colors
      const candleSeries = chart.addCandlestickSeries({
          upColor: 'green',
          borderUpColor: 'green',
          wickUpColor: 'green',
          downColor: 'red',
          borderDownColor: 'red',
          wickDownColor: 'red',
      });

      // Add line series for closing prices
      const lineSeries = chart.addLineSeries({
          color: 'blue',
      });

      // Set data for both candlestick and line series
      candleSeries.setData(data);
      lineSeries.setData(data.map(item => ({
          time: item.time,
          value: item.close
      })));

      chart.timeScale().applyOptions({
          timeVisible: true,        // Show time
          secondsVisible: true,     // Show seconds
          tickMarkFormatter: (time, tickMarkType, locale) => {
              const date = new Date(time * 1000);
              return date.toLocaleTimeString(locale, {
                  hour: '2-digit',
                  minute: '2-digit',
                  second: '2-digit',
              });
          },
      });

      chart.priceScale('right').applyOptions({
          scaleMargins: {
              top: 0.2,
              bottom: 0.2,
          },
      });

      chart.timeScale().applyOptions({
          rightOffset: 5,
          barSpacing: 6,
          fixLeftEdge: true,
      });

      chart.timeScale().fitContent();

      // Toggle button functionality
      document.getElementById('candlestick-btn').addEventListener('click', () => {
          candleSeries.applyOptions({ visible: true });
          lineSeries.applyOptions({ visible: false });
          setActiveButton('candlestick-btn');
      });

      document.getElementById('line-btn').addEventListener('click', () => {
          candleSeries.applyOptions({ visible: false });
          lineSeries.applyOptions({ visible: true });
          setActiveButton('line-btn');
      });

      document.getElementById('both-btn').addEventListener('click', () => {
          candleSeries.applyOptions({ visible: true });
          lineSeries.applyOptions({ visible: true });
          setActiveButton('both-btn');
      });

      // Function to set active button
      function setActiveButton(activeId) {
          const buttons = document.querySelectorAll('.btn-group .btn');
          buttons.forEach(button => {
              if (button.id === activeId) {
                  button.classList.remove('btn-secondary');
                  button.classList.add('btn-primary');
              } else {
                  button.classList.remove('btn-primary');
                  button.classList.add('btn-secondary');
              }
          });
      }

      // Initialize with candlestick chart visible
      document.getElementById('candlestick-btn').click();
    </script>
  </body>
</html>
